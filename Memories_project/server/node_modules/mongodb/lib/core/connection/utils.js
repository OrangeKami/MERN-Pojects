'use strict';

<<<<<<< HEAD
const parsePackageVersion = require('../../utils').parsePackageVersion;
const MongoError = require('../error').MongoError;

const require_optional = require('optional-require')(require);

function debugOptions(debugFields, options) {
  const finaloptions = {};
=======
const require_optional = require('require_optional');

function debugOptions(debugFields, options) {
  var finaloptions = {};
>>>>>>> 3ac36cf94fbdaf2987fe4adaae23b41d0f225e10
  debugFields.forEach(function(n) {
    finaloptions[n] = options[n];
  });

  return finaloptions;
}

function retrieveBSON() {
<<<<<<< HEAD
  const BSON = require('bson');
  BSON.native = false;

  const optionalBSON = require_optional('bson-ext');
  const bsonExtVersion = parsePackageVersion(
    require_optional('bson-ext/package.json') || { version: '0.0.0' }
  );
  if (optionalBSON) {
    if (bsonExtVersion.major >= 4) {
      throw new MongoError(
        'bson-ext version 4 and above does not work with the 3.x version of the mongodb driver'
      );
    }
    optionalBSON.native = true;
    return optionalBSON;
  }
=======
  var BSON = require('bson');
  BSON.native = false;

  try {
    var optionalBSON = require_optional('bson-ext');
    if (optionalBSON) {
      optionalBSON.native = true;
      return optionalBSON;
    }
  } catch (err) {} // eslint-disable-line
>>>>>>> 3ac36cf94fbdaf2987fe4adaae23b41d0f225e10

  return BSON;
}

// Throw an error if an attempt to use Snappy is made when Snappy is not installed
function noSnappyWarning() {
  throw new Error(
    'Attempted to use Snappy compression, but Snappy is not installed. Install or disable Snappy compression and try again.'
  );
}

<<<<<<< HEAD
const PKG_VERSION = Symbol('kPkgVersion');

// Facilitate loading Snappy optionally
function retrieveSnappy() {
  const snappy = require_optional('snappy');
  if (!snappy) {
    return {
=======
// Facilitate loading Snappy optionally
function retrieveSnappy() {
  var snappy = null;
  try {
    snappy = require_optional('snappy');
  } catch (error) {} // eslint-disable-line
  if (!snappy) {
    snappy = {
>>>>>>> 3ac36cf94fbdaf2987fe4adaae23b41d0f225e10
      compress: noSnappyWarning,
      uncompress: noSnappyWarning,
      compressSync: noSnappyWarning,
      uncompressSync: noSnappyWarning
    };
  }
<<<<<<< HEAD

  const snappyPkg = require_optional('snappy/package.json') || { version: '0.0.0' };
  const version = parsePackageVersion(snappyPkg);
  snappy[PKG_VERSION] = version;
  if (version.major >= 7) {
    const compressOriginal = snappy.compress;
    const uncompressOriginal = snappy.uncompress;
    snappy.compress = (data, callback) => {
      compressOriginal(data)
        .then(res => callback(undefined, res))
        .catch(error => callback(error));
    };
    snappy.uncompress = (data, callback) => {
      uncompressOriginal(data)
        .then(res => callback(undefined, res))
        .catch(error => callback(error));
    };
  }

=======
>>>>>>> 3ac36cf94fbdaf2987fe4adaae23b41d0f225e10
  return snappy;
}

module.exports = {
<<<<<<< HEAD
  PKG_VERSION,
=======
>>>>>>> 3ac36cf94fbdaf2987fe4adaae23b41d0f225e10
  debugOptions,
  retrieveBSON,
  retrieveSnappy
};
